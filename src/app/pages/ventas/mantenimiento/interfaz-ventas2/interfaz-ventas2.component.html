<form [formGroup]="forma">
    <div class="layout-dashboard" #general>
        <div class="p-grid">
            <div class="p-col-7">
                <div class="card">
                    <p-dataView #dv [value]="productos" filterBy="titulo,codigo" [sortField]="sortField"
                                    [sortOrder]="sortOrder" layout="grid" *ngIf="modo === 'pos'" [loading]="loading">
                        <ng-template pTemplate="header">
                            <div class="p-d-flex p-flex-column p-flex-md-row p-jc-md-between">
                                <!-- [(ngModel)]="sortKey" -->
                                <p-dropdown [options]="sortOptions" placeholder="Ordenar por precio" (onChange)="onSortChange($event)" 
                                            styleClass="p-mb-2 p-mb-md-0"></p-dropdown>
                                <span class="p-input-icon-left p-mb-2 p-mb-md-0">
                                    <i class="pi pi-search"></i>
                                    <input type="search" pInputText placeholder="Buscar..." (input)="dv.filter($event.target.value)">
                                </span>
                                <!-- <p-dataViewLayoutOptions></p-dataViewLayoutOptions> -->
                            </div>
                        </ng-template>
        
                        <ng-template let-product pTemplate="gridItem" let-i="rowIndex">
                            <div class="p-col-12 p-md-2">
                                <div class="product-grid-item card" (click)="agregarProducto(product, i)" [attr.id]="product.id">
                                    <div class="product-grid-item-top">
                                        <!-- <div>
                                            <i class="pi pi-tag product-category-icon"></i>
                                            <span class="product-category">{{product.categoria | titlecase}}</span>
                                        </div> -->
                                        <!-- <span *ngIf="product.cantidad1 >= product.existenciaMaxima * 0.7" class="p-tag p-tag-success">DISPONIBLE</span>
                                        <span *ngIf="product.cantidad1 < product.existenciaMaxima * 0.7 && product.cantidad1 >= product.existenciaMinima * 3" class="p-tag p-tag-info">DISPONIBLE</span>
                                        <span *ngIf="product.cantidad1 < product.existenciaMinima * 3 && product.cantidad1 > 0" class="p-tag p-tag-warning">STOCK BAJO</span>
                                        <span *ngIf="product.cantidad1 === 0 || product.cantidad1 === null" class="p-tag p-tag-danger">AGOTADO</span> -->
                                    </div>
                                    <div class="product-grid-item-content">
                                        <img [src]="product.galeriaImagenes | invProductos" [alt]="product.titulo"/>
                                        <div class="product-name" style="margin-bottom: 10px;">{{product.titulo | titlecase}}</div>
                                        <!-- <div class="product-description">{{product.codigo}}</div> -->
                                        <!-- <p-rating [ngModel]="product.rating" [readonly]="true" [cancel]="false"></p-rating> -->
                                    </div>
                                    <div class="product-grid-item-bottom">
                                        <span class="product-price p-tag p-tag-info"><i class="fas fa-hashtag"></i>{{product.codigo}}</span>
                                        <span class="product-price p-tag p-tag-success">${{product.precio_venta}}</span>
                                    </div>
                                </div>
                            </div>
                        </ng-template>
                    </p-dataView>
                </div>
            </div>
    
            <div class="p-col-5">
                <div class="card opcion-top">
                    <p-tabView>
                        <p-tabPanel header="General" formArrayName="productos">
                            <p-table #dt [columns]="cols" [value]="productosSeleccionados" styleClass="p-datatable-responsive-demo p-datatable-gridlines p-datatable-striped"
                                    [rowHover]="true" [filterDelay]="0" [globalFilterFields]="['titulo','codigo','categoria','marca']" [scrollable]="true" [scrollHeight]="this.detailHeigth">
                                <!--                                 
                                <ng-template pTemplate="caption">
                                    <div class="table-header">
                                        <span class="p-input-icon-left">
                                            <i class="pi pi-search"></i>
                                            <input pInputText type="text" (input)="dt.filterGlobal($event.target.value, 'contains')" placeholder="Buscar"/>
                                        </span>
                                    </div>
                                </ng-template> -->
                
                                <ng-template pTemplate="header" let-columns>
                                    <tr>
                                        <th *ngFor="let col of columns" [pSortableColumn]="col.field">
                                            {{col.header}}
                                            <p-sortIcon [field]="col.field" *ngIf="(col.field !== 'imagen' && col.field !== 'acciones')"></p-sortIcon>
                                        </th>
                                    </tr>
                                </ng-template>
                
                                <ng-template pTemplate="body" let-rowData let-columns="columns" let-i="rowIndex">
                                    <tr class="p-selectable-row" [formGroupName]="i">
                                        <td *ngFor="let col of columns" [ngClass]="{'centrar': col.field === 'imagen' || col.field === 'acciones'}" >
                                            <span class="p-column-title">{{col.header}}</span>
                
                                            <span *ngIf="col.field === 'titulo'">
                                                <!-- <img [src]="rowData.galeriaImagenes | invProductos" width="64" style="vertical-align: middle"/> -->
                                                <div class="p-mb-3 demo-container p-text-nowrap p-text-truncate" style="width: 7rem" [pTooltip]="rowData['titulo']" tooltipPosition="bottom">										
                                                    {{rowData['titulo']}}
                                                </div>
                                            </span>
<!--                     
                                            <div *ngIf="col.field === 'codigo'">
                                                {{ rowData[col.field] }}
                                            </div> -->
                
                                            <div *ngIf="col.field === 'precio_venta'">
                                                ${{ rowData[col.field] }}
                                            </div>
                
                                            <div *ngIf="col.field === 'cantidad'">
                                                <input type="number" pInputText [min]="1" pKeyFilter="int" formControlName="cantidad1" 
                                                       (input)="recalcula($event.target.value)" style="width: 100%;"/>
                                            </div>
                
                                            <div *ngIf="col.field === 'acciones'">                        
                                                <button pButton pRipple type="button" icon="pi pi-trash" class="p-button p-button-danger p-mr-2 p-mb-2" 
                                                        (click)="eliminarProducto(rowData)">
                                                </button>                       
                                            </div>
                                        </td>                
                                    </tr>
                                </ng-template>
                            </p-table>
                        </p-tabPanel>
                
                        <p-tabPanel *ngFor="let categoria of categorias; let i = index" [header]="categoria.descripcion | titlecase">
                            <p-table #dt2 [columns]="cols2" [value]="productosSeleccionados" styleClass="p-datatable-responsive-demo p-datatable-gridlines p-datatable-striped"
                                    [rowHover]="true" [filterDelay]="0" [globalFilterFields]="['titulo','codigo','categoria','marca']">
                                
                                <ng-template pTemplate="caption">
                                    <div class="table-header">
                                        <span class="p-input-icon-left">
                                            <i class="pi pi-search"></i>
                                            <input pInputText type="text" (input)="dt2.filterGlobal($event.target.value, 'contains')" placeholder="Buscar"/>
                                        </span>
                                    </div>
                                </ng-template>
                
                                <ng-template pTemplate="header" let-columns>
                                    <tr>
                                        <th *ngFor="let col of columns" [pSortableColumn]="col.field">
                                            {{col.header}}
                                            <p-sortIcon [field]="col.field" *ngIf="(col.field !== 'imagen' && col.field !== 'acciones')"></p-sortIcon>
                                        </th>
                                    </tr>
                                </ng-template>
                
                                <ng-template pTemplate="body" let-rowData let-columns="columns" let-i="rowIndex">
                                    <tr class="p-selectable-row" *ngIf="rowData.categoria === categoria.descripcion">
                
                                        <td *ngFor="let col of columns" [ngClass]="{'centrar': col.field === 'imagen'}">
                                            
                                            <span class="p-column-title">{{col.header}}</span>
                
                                            <div *ngIf="col.field === 'imagen'">
                                                <img [alt]="rowData[col.field]" [src]="rowData.galeriaImagenes | invProductos" width="64"
                                                        style="vertical-align: middle"/>
                                                <span [pTooltip]="rowData['titulo']">{{ rowData['titulo'] | titlecase }}</span>
                                            </div>
                
                                            <div *ngIf="col.field === 'titulo'" class="p-mb-3 demo-container p-text-nowrap p-text-truncate" style="width: 6rem">
                                                {{ rowData[col.field] | titlecase }}                                
                                            </div>
                
                                            <div *ngIf="col.field === 'codigo'">
                                                {{ rowData[col.field] }}
                                            </div>
                
                                            <div *ngIf="col.field === 'precio_venta'">
                                                ${{ rowData[col.field] }}
                                            </div>
                
                                            <div *ngIf="col.field === 'cantidad'">
                                                <input pInputText [min]="1" pKeyFilter="int" style="width: 100%;"/>
                                            </div>
                                        </td>                
                                    </tr>
                                </ng-template>
                            </p-table>                
                        </p-tabPanel>
                    </p-tabView>
                </div>

                <div class="layout-dashboard opcion-bottom">
                    <div class="card">   
                        <div class="p-grid">
                            <div class="p-col-2">
                                <div class="card styled-box-green" pRipple (click)="op.toggle($event)" style="height: 80px;">
                                    <div class="p-grid user-card-stats">
                                        <div class="p-col-12 p-text-center">
                                            <i class="botones-bottom fas fa-user"></i>
                                            <div>Clientes</div>
                                        </div>
                                    </div>
                                </div> 
                            </div>
    
                            <div class="p-col-2">
                                <div class="card styled-box-green" pRipple style="height: 80px;">
                                    <div class="p-grid user-card-stats">
                                        <div class="p-col-12 p-text-center">
                                            <i class="botones-bottom fas fa-percent"></i>
                                            <div>Descuentos</div>
                                        </div>
                                    </div>
                                </div> 
                            </div>
    
                            <div class="p-col-2">
                                <div class="card styled-box-green" pRipple style="height: 80px;">
                                    <div class="p-grid user-card-stats">
                                        <div class="p-col-12 p-text-center">
                                            <i class=" botones-bottom fas fa-undo"></i>
                                            <div>Devolución</div>
                                        </div>
                                    </div>
                                </div>  
                            </div>
    
                            <div class="p-col-2">
                                <div class="card styled-box-green" pRipple style="background-color: #ff4949; height: 80px;" >
                                    <div class="p-grid user-card-stats">
                                        <div class="p-col-12 p-text-center">
                                            <i class="botones-bottom pi pi-trash"></i>
                                            <div>Anular</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
    
                            <div class="p-col-2">                            
                                <div class="card styled-box-green" pRipple style="height: 80px;">
                                    <div class="p-grid user-card-stats">
                                        <div class="p-col-12 p-text-center">
                                            <i class="botones-bottom far fa-file-alt"></i>
                                            <div>Cotizar</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
    
                            <div class="p-col-2">
                                <div class="card" [ngClass]="{'chosen': this.financiando}"
                                        style="background-color: #FBC02D; height: 80px;" pRipple (click)="financiar()">
                                    <div class="p-grid user-card-stats">
                                        <div class="p-col-12 p-text-center">
                                            <i class="botones-bottom fas fa-comment-dollar"></i>
                                            <div>Financiar</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
    
                            <div class="p-col-4">
                                <div class="card text-white" *ngIf="!this.financiando" pRipple (click)="cobrarFactura()" style="background-color: #689F38;">
                                    <div class="p-grid user-card-stats">
                                        <div class="p-col-12 p-text-center">
                                            <i class=" botones-bottom fas fa-hand-holding-usd"></i>
                                            <div>Cobrar Factura</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
    
                            <div class="p-col-4">
                                <div class="card financiar-button" *ngIf="this.financiando" pRipple (click)="financiarFactura()" style="background-color: #ffc106;">
                                    <div class="p-grid user-card-stats">
                                        <div class="p-col-12 p-text-center">
                                            <i class=" botones-bottom fas fa-hand-holding-usd"></i>
                                            <div>Financiar Factura</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
    
                    <!-- <div class="card">
                        <div class="p-col-12">
                            <div class="p-grid">
                                <div class="p-col">
                                    <div class="p-fluid">
                                        <div class="p-field p-grid" *ngIf="efectivo === true || ambos === true">
                                            <label for="efectivo" class="p-col-fixed">Efectivo</label>
                                            <div class="p-col">
                                                <input id="efectivo" type="text" pInputText pKeyFilter="int" formControlName="efectivo" [class.P-invalid]="getNoValido('efectivo')" 
                                                   (keyup)="calculaDevueltaE($event.target.value)" [readonly]="this.neto === 0"> 
                                                <small *ngIf="getNoValido('efectivo')" id="efectivo" class="p-invalid">Debe indicar el monto pagado</small>
                                                <small *ngIf="devueltaMenor" class="p-invalid">Monto es menor al total</small>
                                            </div>
                                        </div>
                                        <div class="p-field p-grid" *ngIf="cheque === true">
                                            <label for="cheque_no" class="p-col-fixed" >Cheque</label>
                                            <div class="p-col">
                                                <input id="cheque_no" type="text" pInputText pKeyFilter="int" formControlName="cheque_no"> 
                                            </div>
                                        </div> 
                
                                        <div class="p-field p-grid" *ngIf="tarjeta === true || ambos === true">
                                            <label for="tarjeta_no" class="p-col-fixed">Tarjeta</label>
                                            <div class="p-col">
                                                <input id="tarjeta_no" type="text" pInputText pKeyFilter="int" formControlName="tarjeta_no"> 
                                            </div>
                                        </div> 
                                    </div> 
                                </div>
                                <div class="p-col">
                                    <div class="widget-pricing-card">
                                        <h3 style="text-align: start !important;">$RD {{this.neto}}</h3>
                                        <h4 style="text-align: start !important;">{{this.cliente | uppercase}}</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> -->
                </div>
            </div>
        </div>        
    </div>
   
    <p-toast key="tc"></p-toast>
        
    <p-overlayPanel #op [showCloseIcon]="true" [style]="{width: '450px'}">
        <ng-template pTemplate>
            <p-table #dt3 [value]="clientes" selectionMode="single" [(selection)]="clientesSeleccionados" (onRowSelect)="clienteSeleccionado($event.data)" 
                        [paginator]="true" [rows]="5" [globalFilterFields]="['nombre','num_rnc','cedula']">
                <ng-template pTemplate="caption">
                <div class="table-header">
                    <span class="p-input-icon-left">
                        <i class="pi pi-search"></i>
                        <input pInputText type="text" (input)="dt3.filterGlobal($event.target.value, 'contains')" placeholder="Buscar Cliente..."/>
                    </span>
                </div>
            </ng-template>
                <ng-template pTemplate="header">
                    <tr>
                        <th pSortableColumn="nombre">Nombre<p-sortIcon field="name"></p-sortIcon></th>                    
                        <th pSortableColumn="num_rnc">RNC <p-sortIcon field="price"></p-sortIcon></th>
                        <th pSortableColumn="cedula">Cédula <p-sortIcon field="price"></p-sortIcon></th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-rowData let-cliente>
                    <tr [pSelectableRow]="rowData">
                        <td>{{cliente.nombre}}</td>
                        <td>{{cliente.num_rnc}}</td>
                        <td>{{cliente.cedula}}</td>
                    </tr>
                </ng-template>
            </p-table>
        </ng-template>
    </p-overlayPanel>
</form>    